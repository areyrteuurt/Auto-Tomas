name: Scrape-By-Country

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */12 * * *"

permissions:
  contents: write
  actions: write

jobs:
  scrape-and-update:
    runs-on: ubuntu-latest
    concurrency:
      group: main-workflow
      cancel-in-progress: true

    steps:
      - name: ğŸ“¥ Check out repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: âš™ï¸ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r ./config/requirements.txt
          pip list

      - name: ğŸ•¸ï¸ Run scraping script
        run: python ./config/scraper.py
        env:
          GITHUB_WORKSPACE: ${{ github.workspace }}

      - name: ğŸ” Verify generated files
        run: |
          echo "Verifying file existence..."
          ls -la
          ls -la output_configs/
          ls -la output_configs/countries/ || echo "Countries directory not found"
          ls -la output_configs/protocols/ || echo "Protocols directory not found"
          cat update_log.txt || echo "Update log not found"

      - name: ğŸ”§ Configure Git
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git config --global core.autocrlf false

      - name: ğŸ“ Prepare git add command
        run: |
          echo "Adding all generated files to git..."
          # ç¡®ä¿æ·»åŠ output_configsä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼ŒåŒ…æ‹¬å­ç›®å½•
          git add --force output_configs/ README.md update_log.txt

      - name: â° Set commit time to CST format
        run: |
          # ä½¿ç”¨TZç¯å¢ƒå˜é‡ä¸´æ—¶è®¾ç½®æ—¶åŒºä¸ºAsia/Shanghaiï¼Œç„¶åæ ¼å¼åŒ–ä¸ºCST
          CURRENT_TIME=$(TZ='Asia/Shanghai' date +"%Y-%m-%d %H:%M:%S CST")
          echo "CURRENT_TIME=$CURRENT_TIME" >> $GITHUB_ENV

      - name: â¬†ï¸ Commit and Push Changes
        run: |
          # ä½¿ç”¨--forceå‚æ•°ç¡®ä¿æ‰€æœ‰å˜æ›´éƒ½è¢«æ·»åŠ ï¼ŒåŒ…æ‹¬ç›®å½•ä¸­çš„æ–‡ä»¶
          git add --force output_configs/
          
          echo "Committing changes..."
          git commit --date="$CURRENT_TIME" -m "docs: Update configs and README - $CURRENT_TIME"
          
          echo "Pushing changes..."
          git push origin main
